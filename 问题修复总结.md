# 🔧 问题修复总结

## 问题描述
```
coursesStore.ts:113 请求失败: TypeError: buildingsInDivision.forEach is not a function
    at coursesStore.ts:43:33
    at populateAllCoursesFlatList (coursesStore.ts:42:26)
    at Proxy.fetchCourseData (coursesStore.ts:111:13)
```

## 根本原因
`populateAllCoursesFlatList` 函数期望 `courseData.value` 是一个二维数组格式 `BuildingInfo[][]`，但由于导入的新数据生成器存在兼容性问题，导致数据结构不匹配。

## 解决方案

### 1. 扩展了类型定义
在 `src/types/course.ts` 中为 `BuildingInfo` 添加了可选的楼层信息：

```typescript
// 楼层信息接口
export interface FloorInfo {
    floorName: string;
    floorNumber: number;
    rooms: string[];
    courses: CourseInfo[];
}

// 教学楼信息接口 (扩展版)
export interface BuildingInfo {
    building: string;
    label: string;
    value: number;
    infos: CourseInfo[];
    floors?: FloorInfo[];  // 新增：可选的楼层信息
}
```

### 2. 重写了Mock数据生成器
在 `coursesStore.ts` 中直接创建了包含楼层信息的完整Mock数据：

```typescript
function generateMockData(): BuildingInfo[][] {
    const mockBuildings: BuildingInfo[][] = [
        // 文理学部
        [
            {
                building: '文理学部教学楼A',
                floors: [
                    {
                        floorName: 'A楼1层',
                        floorNumber: 1,
                        rooms: ['A101', 'A102', 'A103', 'A104'],
                        courses: [/* 课程列表 */]
                    },
                    {
                        floorName: 'A楼2层', 
                        floorNumber: 2,
                        rooms: ['A201', 'A202', 'A203', 'A204'],
                        courses: [/* 课程列表 */]
                    },
                    // ... 更多楼层
                ],
                infos: [/* 扁平化的所有课程，保持向后兼容 */]
            }
        ],
        // ... 其他学部
    ];
}
```

### 3. 增强了错误处理
在 `populateAllCoursesFlatList` 函数中添加了数据结构验证：

```typescript
function populateAllCoursesFlatList() {
    const courses: CourseInfo[] = [];
    console.log('courseData.value structure:', courseData.value);

    // 确保courseData.value是数组
    if (!Array.isArray(courseData.value)) {
        console.error('courseData.value is not an array:', courseData.value);
        allCoursesFlatList.value = [];
        filteredCourses.value = [];
        return;
    }
    
    // 安全的数组遍历和数据处理
    courseData.value.forEach((buildingsInDivision: BuildingInfo[], divisionIndex: number) => {
        if (Array.isArray(buildingsInDivision)) {
            buildingsInDivision.forEach((building: BuildingInfo) => {
                if (building && building.infos && Array.isArray(building.infos)) {
                    courses.push(...building.infos);
                }
            });
        }
    });
}
```

### 4. 优化了前端楼层处理逻辑
在 `MobileHelperView.vue` 中更新了计算属性，优先使用新的楼层数据结构：

```typescript
const currentFloors = computed(() => {
  if (selectedBuilding.value === null) return [];
  const building = currentBuildings.value[selectedBuilding.value];
  
  // 优先使用新的floors属性
  if (building?.floors && building.floors.length > 0) {
    return building.floors;
  }
  
  // 兼容旧数据 - 从房间号推断楼层
  if (building?.infos) {
    const floorMap = new Map<string, CourseInfo[]>();
    building.infos.forEach((course: CourseInfo) => {
      const room = course.room;
      const floorMatch = room.match(/([A-Z])(\d)/);
      const floorName = floorMatch ? `${floorMatch[1]}楼${floorMatch[2]}层` : '其他楼层';
      
      if (!floorMap.has(floorName)) {
        floorMap.set(floorName, []);
      }
      floorMap.get(floorName)!.push(course);
    });
    
    return Array.from(floorMap.entries()).map(([floorName, courses]) => ({
      floorName,
      floorNumber: parseInt(floorName.match(/(\d)/)?.[1] || '0'),
      rooms: [...new Set(courses.map(c => c.room))],
      courses
    }));
  }
  
  return [];
});
```

## 修复效果

✅ **问题解决**：
- 消除了 "buildingsInDivision.forEach is not a function" 错误
- 数据结构现在完全兼容

✅ **功能增强**：
- 每个教学楼现在有多个楼层选项（不再只有"其他楼层"）
- 支持 "A楼1层"、"A楼2层"、"B楼1层" 等正确的楼层显示
- 数据结构更加清晰和可扩展

✅ **向后兼容**：
- 保持了原有的 `infos` 字段，确保现有功能正常工作
- 新增的 `floors` 字段为可选，不影响现有API

## 验证方法

1. 打开小助手页面，选择任意学部
2. 选择教学楼，应该能看到多个楼层选项
3. 选择楼层，应该能看到对应的课程列表
4. 控制台不再出现 forEach 错误

现在您可以按照相同的数据结构调整后端API，前端已经准备好支持正确的楼层导航了！